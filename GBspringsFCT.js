// start the oven at a 190F Convect Bake before running this code.

var greenBean = require("green-bean");
var period = 5000;
var offset = 100;
var startTemp = 200; //The temperature needed to start the cycle.

var PROFILE1 = [
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  { temp: 600, duration: 10000 },
  ];

var compareTemp = function(range,tempRTD, tempSet) {
        tempSet = tempSet + offset; //add the offset from RTD to Center of oven.
        if(tempRTD < tempSet) {
            console.log("turn oven ON");
            
            range.elementStatus.write({
              upperOvenElementStatus: 0,
              lowerOvenElementStatus: 12
            });
        } else if (tempRTD > tempSet) {
              console.log("turn oven OFF");
              range.elementStatus.write({
               upperOvenElementStatus: 0,
               lowerOvenElementStatus: 0
              });
            }
};

function startFan(range) {

    range.convectionFan.write({
        upperOvenConvectionFanDrivePercentage: 0,
        upperOvenConvectionFanRotation: 1,
        lowerOvenConvectionFanDrivePercentage: 0,
        lowerOvenConvectionFanRotation: 0
    });
}



function startCooking(range, profile, callback, step) {
  var index = step || 0;
  var setpoint = profile[index];
  var hysteresis = 1;
  var tempNow = 0;

  if (setpoint) {
    console.log('setting temp to ' + setpoint.temp);
    range.analogInputs.read(function(value) {
	        tempNow = value.lowerOvenRtd;
          console.log("Lower Oven RTD is:", tempNow, "F");
          setTimeout(compareTemp(range, tempNow, setpoint.temp),100);		
	   });

          setTimeout(startCooking.bind(this, range, profile, callback, index + 1),
            setpoint.duration);
    
  } else {
    	range.elementStatus.write({
    		upperOvenElementStatus: 0,
    		lowerOvenElementStatus: 0});
    	callback(null);
  }
};

greenBean.connect("range", function(range) {

    range.fctMode.write(1); // enter fct mode

    setInterval(function() {
        range.fctMode.write(1); // stay in fct mode
    }, 15000);
    
    startFan(range);
    startCooking(range, PROFILE1, function(err) {
      if (err) console.error(err);
      else {
        console.log('cool beans');
        range.buzzerTone.write(5);
      }
    });
});
